<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Editor - FastPage</title>
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>‚ö°</text></svg>"/>
  <style>
    :root{--primary:#7c3aed;--muted:#64748b;--surface:#fff}
    *{box-sizing:border-box;font-family:Inter,system-ui,sans-serif}
    body{margin:0;background:#f8f6ff;color:#0f172a}
    .topbar{display:flex;align-items:center;justify-content:space-between;padding:1rem 1.5rem;background:linear-gradient(90deg,#fff,#f8f6ff);border-bottom:1px solid rgba(0,0,0,0.04)}
    .brand{display:flex;gap:0.75rem;align-items:center;font-weight:800;color:var(--primary)}
    .controls{display:flex;gap:0.5rem;align-items:center}
    .btn{padding:8px 12px;border-radius:8px;border:1px solid rgba(0,0,0,0.06);cursor:pointer;background:white}
    .btn.primary{background:linear-gradient(90deg,var(--primary),#8b5cf6);color:#fff;border:none}
    
    .btn.icon{padding:6px 8px;font-size:12px;line-height:1;border-radius:6px}
    .btn.icon.secondary{background:#f1f5f9;border:1px solid rgba(0,0,0,0.06)}
    .btn.icon.secondary:hover{background:#e2e8f0}
    .block-controls{display:flex;gap:6px;align-items:center}
    .block-controls .btn{min-width:28px}
    .layout{display:grid;grid-template-columns:300px 1fr 340px;gap:1rem;padding:1rem}
    .panel{background:var(--surface);border-radius:12px;padding:1rem;border:1px solid rgba(0,0,0,0.04)}
    .canvas{min-height:600px;border:2px dashed rgba(0,0,0,0.06);border-radius:12px;padding:1rem;background:#fff}
    .block{padding:12px;border-radius:8px;background:linear-gradient(180deg,#fff,#f7f7ff);margin-bottom:8px;border:1px solid rgba(0,0,0,0.03);cursor:grab}
    .block[draggable="true"]{user-select:none}
    .block.dragging{opacity:0.6}
    .block .block-content{width:100%}
    .block .block-content [contenteditable="true"]{outline:none;border-bottom:1px dashed transparent;transition:all 0.2s ease}
    .block .block-content [contenteditable="true"]:focus{border-color:rgba(124,58,237,0.45);background:rgba(124,58,237,0.04)}
    .block .emoji-card{display:flex;gap:12px;align-items:flex-start;padding:12px;border-radius:12px;background:#fff;border:1px solid rgba(0,0,0,0.05)}
    .block .emoji{font-size:24px;line-height:1}
    .block .grid-3{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:12px}
    .block .grid-2{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:12px}
    .block .stack{display:flex;flex-direction:column;gap:10px}
    .block .pill{display:inline-flex;align-items:center;gap:6px;background:#f1f5f9;border-radius:999px;padding:6px 10px;font-size:12px;font-weight:700}
    .block .cta{display:inline-flex;align-items:center;gap:8px;background:linear-gradient(90deg,var(--primary),#8b5cf6);color:#fff;border-radius:10px;padding:10px 14px;font-weight:700}
    .block .pricing-grid{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:12px}
    .block .pricing-card{border:1px solid rgba(0,0,0,0.06);border-radius:14px;padding:14px;background:#fff}
    .block .pricing-card.highlight{border-color:rgba(124,58,237,0.4);box-shadow:0 8px 20px rgba(124,58,237,0.12)}
    .block .comparison{border:1px solid rgba(0,0,0,0.06);border-radius:12px;overflow:hidden}
    .block .comparison-row{display:grid;grid-template-columns:1.3fr repeat(3,minmax(0,1fr));gap:8px;padding:10px 12px;border-top:1px solid rgba(0,0,0,0.04)}
    .block .comparison-row.header{background:#f8fafc;font-weight:700;border-top:none}
    .block .payment-grid{display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:10px}
    .block .payment-card{border:1px dashed rgba(0,0,0,0.15);border-radius:12px;padding:10px;text-align:center;background:#fff;font-weight:700}
    .block .faq-item{border:1px solid rgba(0,0,0,0.06);border-radius:10px;padding:10px 12px;background:#fff}
    .block details.faq-item summary{cursor:pointer;font-weight:700}
    .block .testi-card{border:1px solid rgba(0,0,0,0.06);border-radius:12px;padding:12px;background:#fff}
    .placeholder{min-height:80px;border:2px dashed rgba(124,58,237,0.08);border-radius:8px;margin-bottom:8px;display:flex;align-items:center;justify-content:center;color:var(--muted)}
    .templates{display:grid;grid-template-columns:1fr;gap:0.5rem}
    .small{font-size:0.85rem;color:var(--muted)}
    @media(max-width:900px){
      .layout{grid-template-columns:1fr;}
      .panel.right{order:3}
      .block .grid-3,.block .grid-2,.block .pricing-grid{grid-template-columns:1fr}
      .block .comparison-row{grid-template-columns:1fr}
      .block .payment-grid{grid-template-columns:repeat(2,minmax(0,1fr))}
    }
    @media(max-width:520px){
      .block .payment-grid{grid-template-columns:1fr}
    }
  </style>
</head>
<body>
  <div class="topbar">
    <div class="brand">‚ö° FastPage Editor <span class="small">‚Äî Construir landing pages</span></div>
    <div class="controls">
      <button class="btn" id="previewBtn">Vista previa</button>
      <button class="btn" id="publishBtn">Publicar</button>
      <button class="btn primary" id="saveBtn">Guardar</button>
    </div>
  </div>

  <div class="layout">
    <aside class="panel left">
      <h4>Bloques</h4>
      <div draggable="true" class="block" data-type="hero">üöÄ Hero (T√≠tulo + CTA)</div>
      <div draggable="true" class="block" data-type="features">‚ú® Caracter√≠sticas (3 columnas)</div>
      <div draggable="true" class="block" data-type="ecommerce">üõí E-commerce (beneficios)</div>
      <div draggable="true" class="block" data-type="testimonials">üí¨ Testimonios</div>
      <div draggable="true" class="block" data-type="pricing">üíé Planes y Precios</div>
      <div draggable="true" class="block" data-type="comparison">üìä Comparativa de precios</div>
      <div draggable="true" class="block" data-type="payments">üí≥ M√©todos de pago (Per√∫)</div>
      <div draggable="true" class="block" data-type="faq">‚ùì FAQ Acorde√≥n</div>
      <hr/>
      <h4>Plantillas</h4>
      <div class="templates">
        <button class="btn" onclick="useTemplate('startup')">Startup (moderno)</button>
        <button class="btn" onclick="useTemplate('product')">Product (landing)</button>
      </div>
    </aside>

    <main class="panel canvas" id="canvas">
      <div class="placeholder">Arrastra bloques aqu√≠ para construir tu landing</div>
    </main>

    <aside class="panel right">
      <h4>Inspector</h4>
      <div id="inspectorEmpty" class="small">Selecciona un bloque para editar sus propiedades.</div>
      <div id="inspector"></div>
    </aside>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.2.0/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.2.0/firebase-auth.js";
    import { getFirestore, collection, addDoc, doc, setDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.2.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBwG1SGZvp97zau4AGOIQxnIlNt9ig8dbs",
      authDomain: "fast-page-726db.firebaseapp.com",
      projectId: "fast-page-726db",
      storageBucket: "fast-page-726db.firebasestorage.app",
      messagingSenderId: "850638079580",
      appId: "1:850638079580:web:0a70125759adced1d30899",
      measurementId: "G-F22PMSZ703"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    let currentUser = null;
    onAuthStateChanged(auth, (user) => { currentUser = user; });

    // Mobile-first responsive behavior: panels collapse under 900px
    const blocks = document.querySelectorAll('.block[draggable]');
    const canvas = document.getElementById('canvas');
    const inspector = document.getElementById('inspector');
    const inspectorEmpty = document.getElementById('inspectorEmpty');
    const leftPanel = document.querySelector('.panel.left');
    const rightPanel = document.querySelector('.panel.right');

    // Device preview
    const previewMode = { device: 'desktop' };
    function setDevice(mode){ previewMode.device = mode; document.body.dataset.device = mode; }
    // expose for UI (could add buttons later)
    window.setDevice = setDevice;

    // Enhance blocks list with emoji and descriptive icons
    // Turn nodeList into live drag handlers
    blocks.forEach(b=>{
      b.addEventListener('dragstart', (e)=>{
        e.dataTransfer.setData('text/plain', JSON.stringify({type: b.dataset.type, label: b.dataset.label || b.textContent.trim()}));
      });
    });

    canvas.addEventListener('dragover', e=>{ e.preventDefault(); });
    canvas.addEventListener('drop', e=>{
      e.preventDefault();
      let data = null;
      try{ data = JSON.parse(e.dataTransfer.getData('text/plain')); }catch(err){ }
      if(!data) return;
      const el = createBlockElement(data.type, data.label);
      canvas.appendChild(el);
      selectBlock(el);
    }
    function getDragAfterElement(container, y){
      const draggableElements = [...container.querySelectorAll('.block:not(.dragging)')];
      return draggableElements.reduce((closest, child)=>{
        const box = child.getBoundingClientRect();
        const offset = y - box.top - box.height / 2;
        if(offset < 0 && offset > closest.offset){
          return { offset, element: child };
        }
        return closest;
      }, { offset: Number.NEGATIVE_INFINITY, element: null }).element;
    }

    canvas.addEventListener('dragover', (e)=>{
      e.preventDefault();
      const dragging = document.querySelector('.block.dragging');
      if(!dragging) return;
      const afterElement = getDragAfterElement(canvas, e.clientY);
      if(afterElement == null){
        canvas.appendChild(dragging);
      } else {
        canvas.insertBefore(dragging, afterElement);
      }
    }););

    function getTemplateHtml(type, label){
      const title = label || 'Tu landing que convierte';
      if(type==='hero'){
        return `
          <div class="stack">
            <div class="pill" data-edit="badge">‚ö° No-code ‚Ä¢ Drag & Drop</div>
            <h2 data-edit="title" style="font-size:28px;font-weight:800;margin:0;">${title}</h2>
            <p class="small" data-edit="subtitle">Crea p√°ginas de e-commerce con pagos locales, SEO y alta conversi√≥n.</p>
            <div class="cta" data-edit="cta">üöÄ Empezar ahora</div>
            <div class="small" data-edit="trust">üîí Sin tarjeta ‚Ä¢ 100% responsive ‚Ä¢ Publica en 1 clic</div>
          </div>
        `;
      }
      if(type==='features'){
        return `
          <div class="stack">
            <div style="font-weight:800" data-edit="title">‚ú® Caracter√≠sticas que venden</div>
            <div class="grid-3">
              <div class="emoji-card">
                <div class="emoji">‚ö°</div>
                <div>
                  <div style="font-weight:700" data-edit="f1t">Carga ultra r√°pida</div>
                  <div class="small" data-edit="f1d">Optimizado para m√≥vil y SEO.</div>
                </div>
              </div>
              <div class="emoji-card">
                <div class="emoji">üéØ</div>
                <div>
                  <div style="font-weight:700" data-edit="f2t">Bloques editables</div>
                  <div class="small" data-edit="f2d">Edita dentro del bloque con un clic.</div>
                </div>
              </div>
              <div class="emoji-card">
                <div class="emoji">üìà</div>
                <div>
                  <div style="font-weight:700" data-edit="f3t">Mayor conversi√≥n</div>
                  <div class="small" data-edit="f3d">Secciones dise√±adas para vender.</div>
                </div>
              </div>
            </div>
          </div>
        `;
      }
      if(type==='ecommerce'){
        return `
          <div class="stack">
            <div style="font-weight:800" data-edit="title">üõí E-commerce listo para vender</div>
            <div class="grid-3">
              <div class="emoji-card">
                <div class="emoji">üöö</div>
                <div>
                  <div style="font-weight:700" data-edit="e1t">Env√≠os y tracking</div>
                  <div class="small" data-edit="e1d">Promesas de entrega claras y r√°pidas.</div>
                </div>
              </div>
              <div class="emoji-card">
                <div class="emoji">üí≥</div>
                <div>
                  <div style="font-weight:700" data-edit="e2t">Pagos locales</div>
                  <div class="small" data-edit="e2d">Yape, Plin y bancos peruanos.</div>
                </div>
              </div>
              <div class="emoji-card">
                <div class="emoji">üßæ</div>
                <div>
                  <div style="font-weight:700" data-edit="e3t">Checkout claro</div>
                  <div class="small" data-edit="e3d">Reduce fricci√≥n y aumenta ventas.</div>
                </div>
              </div>
            </div>
          </div>
        `;
      }
      if(type==='testimonials'){
        return `
          <div class="stack">
            <div style="font-weight:800" data-edit="title">üí¨ Testimonios reales</div>
            <div class="grid-3">
              <div class="testi-card">
                <div data-edit="t1q">"Vend√≠ 3x m√°s con mi landing."</div>
                <div class="small" data-edit="t1n">‚Äî Mar√≠a, Tienda de ropa</div>
              </div>
              <div class="testi-card">
                <div data-edit="t2q">"Configurar pagos locales fue rapid√≠simo."</div>
                <div class="small" data-edit="t2n">‚Äî Diego, Servicios</div>
              </div>
              <div class="testi-card">
                <div data-edit="t3q">"Plantillas pensadas para convertir."</div>
                <div class="small" data-edit="t3n">‚Äî Luisa, E-commerce</div>
              </div>
            </div>
          </div>
        `;
      }
      if(type==='pricing'){
        return `
          <div class="stack">
            <div style="font-weight:800" data-edit="title">üíé Planes y precios</div>
            <div class="pricing-grid">
              <div class="pricing-card">
                <div style="font-weight:700" data-edit="p1t">Starter</div>
                <div style="font-size:22px;font-weight:800" data-edit="p1p">S/0</div>
                <div class="small" data-edit="p1s">1 landing ‚Ä¢ Bloques b√°sicos</div>
                <div class="small" data-edit="p1f">‚úÖ Soporte email</div>
              </div>
              <div class="pricing-card highlight">
                <div style="font-weight:700" data-edit="p2t">Pro</div>
                <div style="font-size:22px;font-weight:800" data-edit="p2p">S/49</div>
                <div class="small" data-edit="p2s">Ilimitadas ‚Ä¢ Pagos locales</div>
                <div class="small" data-edit="p2f">‚úÖ SEO + Anal√≠tica</div>
              </div>
              <div class="pricing-card">
                <div style="font-weight:700" data-edit="p3t">Business</div>
                <div style="font-size:22px;font-weight:800" data-edit="p3p">S/129</div>
                <div class="small" data-edit="p3s">Equipo + Integraciones</div>
                <div class="small" data-edit="p3f">‚úÖ Soporte 24/7</div>
              </div>
            </div>
          </div>
        `;
      }
      if(type==='comparison'){
        return `
          <div class="stack">
            <div style="font-weight:800" data-edit="title">üìä Comparativa de planes</div>
            <div class="comparison">
              <div class="comparison-row header">
                <div data-edit="c0">Funci√≥n</div>
                <div data-edit="c1">Starter</div>
                <div data-edit="c2">Pro</div>
                <div data-edit="c3">Business</div>
              </div>
              <div class="comparison-row">
                <div data-edit="c4">Landings</div>
                <div data-edit="c5">1</div>
                <div data-edit="c6">Ilimitadas</div>
                <div data-edit="c7">Ilimitadas</div>
              </div>
              <div class="comparison-row">
                <div data-edit="c8">Pagos locales</div>
                <div data-edit="c9">‚Äî</div>
                <div data-edit="c10">‚úÖ</div>
                <div data-edit="c11">‚úÖ</div>
              </div>
              <div class="comparison-row">
                <div data-edit="c12">Soporte</div>
                <div data-edit="c13">Email</div>
                <div data-edit="c14">Prioritario</div>
                <div data-edit="c15">24/7</div>
              </div>
            </div>
          </div>
        `;
      }
      if(type==='payments'){
        return `
          <div class="stack">
            <div style="font-weight:800" data-edit="title">üí≥ M√©todos de pago en Per√∫</div>
            <div class="payment-grid">
              <div class="payment-card" data-edit="pay1">Yape</div>
              <div class="payment-card" data-edit="pay2">Plin</div>
              <div class="payment-card" data-edit="pay3">BCP</div>
              <div class="payment-card" data-edit="pay4">BBVA</div>
              <div class="payment-card" data-edit="pay5">Scotiabank</div>
              <div class="payment-card" data-edit="pay6">Interbank</div>
              <div class="payment-card" data-edit="pay7">Banco Pichincha</div>
              <div class="payment-card" data-edit="pay8">Caja Arequipa</div>
            </div>
            <div class="small" data-edit="note">Transferencias, QR y tarjetas integradas.</div>
          </div>
        `;
      }
      if(type==='faq'){
        return `
          <div class="stack">
            <div style="font-weight:800" data-edit="title">‚ùì Preguntas frecuentes</div>
            <details class="faq-item">
              <summary data-edit="q1">¬øC√≥mo publico mi landing?</summary>
              <div class="small" data-edit="a1">Con un clic, tu landing queda lista para compartir.</div>
            </details>
            <details class="faq-item">
              <summary data-edit="q2">¬øPuedo editar en m√≥vil?</summary>
              <div class="small" data-edit="a2">S√≠, el editor y las landings son 100% responsive.</div>
            </details>
            <details class="faq-item">
              <summary data-edit="q3">¬øAcepta pagos locales?</summary>
              <div class="small" data-edit="a3">Integra Yape, Plin y bancos peruanos f√°cilmente.</div>
            </details>
          </div>
        `;
      }
      if(type==='widget'){
        return `
          <div class="stack">
            <div style="font-weight:800" data-edit="title">üîß Widget embebido</div>
            <div class="small" data-edit="subtitle">Inserta HTML o iframe desde propiedades.</div>
          </div>
        `;
      }
      return `<div class="stack"><div data-edit="title">${title}</div></div>`;
    }

    function setBlockContent(el, html){
      el.innerHTML = `<div class="block-content">${html}</div>`;
      el.dataset.inline = 'true';
      enableInlineEditing(el);
    }

    function enableInlineEditing(el){
      const content = el.querySelector('.block-content');
      if(!content) return;
      content.querySelectorAll('[data-edit]').forEach((node)=>{
        node.setAttribute('contenteditable','true');
        node.setAttribute('spellcheck','false');
      });
      const sync = () => { el.dataset.html = content.innerHTML; };
      content.addEventListener('input', sync);
      content.addEventListener('blur', sync, true);
      el.dataset.html = content.innerHTML;
    }

    function getBlockInnerHtml(el){
      if(el.dataset.html) return el.dataset.html;
      const content = el.querySelector('.block-content');
      return content ? content.innerHTML : el.innerHTML;
    }

    function createBlockElement(type, label){
      const el = document.createElement('div');
      el.className = 'block';
      el.setAttribute('draggable','true');
      el.dataset.type = type || 'block';
      el.dataset.props = JSON.stringify({bg:'#ffffff', color:'#0f172a', fontSize:16, padding:20, radius:8});

      setBlockContent(el, getTemplateHtml(type, label));

      el.addEventListener('click', ()=> selectBlock(el));
      el.addEventListener('dragstart', (e)=>{ el.classList.add('dragging'); e.dataTransfer.setData('text/plain', JSON.stringify({type: el.dataset.type, label: el.textContent})); });
      el.addEventListener('dragend', ()=>{ el.classList.remove('dragging'); });
      return el;
    }

    function selectBlock(el){
      document.querySelectorAll('#canvas .block').forEach(x=>x.style.outline='');
      el.style.outline = '2px solid rgba(124,58,237,0.2)';
      inspectorEmpty.style.display='none';
      const props = JSON.parse(el.dataset.props || '{}');
      const type = el.dataset.type || 'block';

      inspector.innerHTML = '';
      // Header
      const header = document.createElement('div'); header.style.marginBottom='8px'; header.style.fontWeight='700'; header.textContent = type.toUpperCase(); inspector.appendChild(header);

      // Properties: background, color, fontSize, padding, radius
      inspector.appendChild(makeLabel('Fondo'));
      const bgInput = makeInput('color', props.bg || '#ffffff'); inspector.appendChild(bgInput);
      inspector.appendChild(makeLabel('Color Texto'));
      const colorInput = makeInput('color', props.color || '#0f172a'); inspector.appendChild(colorInput);
      inspector.appendChild(makeLabel('TamaÒo Fuente'));
      const sizeInput = makeInput('number', props.fontSize || 16); sizeInput.style.width='80px'; inspector.appendChild(sizeInput);
      inspector.appendChild(makeLabel('Padding'));
      const padInput = makeInput('number', props.padding || 20); padInput.style.width='80px'; inspector.appendChild(padInput);
      inspector.appendChild(makeLabel('Redondeo'));
      const radInput = makeInput('number', props.radius || 8); radInput.style.width='80px'; inspector.appendChild(radInput);

      // Content editor
      inspector.appendChild(makeLabel('Contenido'));
      let txt = null;
      if(el.dataset.inline === 'true'){
        const note = document.createElement('div');
        note.className = 'small';
        note.textContent = 'Edita el contenido directamente dentro del bloque.';
        inspector.appendChild(note);
      } else {
        txt = document.createElement('textarea');
        txt.style.width = '100%';
        txt.style.height = '90px';
        txt.value = el.textContent;
        inspector.appendChild(txt);
      }

            // Actions
      const actions = document.createElement('div'); actions.style.display='flex'; actions.style.gap='8px'; actions.style.marginTop='8px';
      const moveUp = document.createElement('button'); moveUp.className='btn icon secondary'; moveUp.textContent='^'; moveUp.title='Subir'; moveUp.onclick=()=>{
        const prev = el.previousElementSibling;
        if(prev) el.parentNode.insertBefore(el, prev);
      };
      const moveDown = document.createElement('button'); moveDown.className='btn icon secondary'; moveDown.textContent='v'; moveDown.title='Bajar'; moveDown.onclick=()=>{
        const next = el.nextElementSibling;
        if(next) el.parentNode.insertBefore(next, el);
      };
      const apply = document.createElement('button'); apply.className='btn primary'; apply.textContent='Aplicar'; apply.onclick=()=>{
        const newProps = { bg: bgInput.value, color: colorInput.value, fontSize: Number(sizeInput.value), padding: Number(padInput.value), radius: Number(radInput.value) };
        el.dataset.props = JSON.stringify(newProps);
        if(txt && !txt.hidden){
          setBlockContent(el, `<div class="stack"><div data-edit="title">${txt.value}</div></div>`);
        }
        el.dataset.html = getBlockInnerHtml(el);
        renderBlock(el);
      };
      const del = document.createElement('button'); del.className='btn'; del.textContent='Eliminar'; del.onclick=()=>{ el.remove(); inspector.innerHTML=''; inspectorEmpty.style.display='block'; };
      const controls = document.createElement('div'); controls.className='block-controls';
      controls.appendChild(moveUp); controls.appendChild(moveDown); controls.appendChild(del);
      actions.appendChild(controls); actions.appendChild(apply); inspector.appendChild(actions);

      window._selected = el;
    }

    function makeLabel(txt){ const l = document.createElement('div'); l.textContent = txt; l.style.marginTop='8px'; l.style.fontWeight='600'; l.className='small'; return l; }
    function makeInput(type, val){ const i = document.createElement('input'); i.type = type; i.value = val; i.style.padding='8px'; i.style.marginBottom='6px'; i.style.border='1px solid rgba(0,0,0,0.08)'; i.style.borderRadius='6px'; return i; }

    function renderBlock(el){
      const props = JSON.parse(el.dataset.props || '{}');
      el.style.background = props.bg || '#fff';
      el.style.color = props.color || '#0f172a';
      el.style.fontSize = (props.fontSize || 16) + 'px';
      el.style.padding = (props.padding || 20) + 'px';
      el.style.borderRadius = (props.radius || 8) + 'px';
      const html = el.dataset.html || getTemplateHtml(el.dataset.type, el.textContent);
      setBlockContent(el, html);
    }

    window.useTemplate = function(name){
      canvas.innerHTML = '';
      if(name==='startup'){
        canvas.appendChild(createBlockElement('hero','?? Tu landing lista en minutos'));
        canvas.appendChild(createBlockElement('features','? CaracterÌsticas que convierten'));
        canvas.appendChild(createBlockElement('ecommerce','?? E-commerce listo para vender'));
        canvas.appendChild(createBlockElement('pricing','?? Planes y precios'));
        canvas.appendChild(createBlockElement('comparison','?? Comparativa de planes'));
        canvas.appendChild(createBlockElement('payments','?? MÈtodos de pago Per˙'));
        canvas.appendChild(createBlockElement('faq','? FAQ'));
      } else if(name==='product'){
        canvas.appendChild(createBlockElement('hero','? Producto estrella'));
        canvas.appendChild(createBlockElement('testimonials','?? Testimonios'));
        canvas.appendChild(createBlockElement('pricing','?? Planes y precios'));
        canvas.appendChild(createBlockElement('payments','?? MÈtodos de pago Per˙'));
        canvas.appendChild(createBlockElement('faq','? FAQ'));
      }
    };

    // Remote save & publish (keep as before but include props/structure)
    async function saveRemote() {
      if(!currentUser){ if(confirm('Necesitas iniciar sesi√≥n para guardar en la nube. Ir a iniciar sesi√≥n ahora?')) window.location.href = '/auth.html'; return; }
      const content = Array.from(document.querySelectorAll('#canvas .block')).map(b=>({type:b.dataset.type || 'block', html: getBlockInnerHtml(b), props: b.dataset.props ? JSON.parse(b.dataset.props) : {}}));
      const title = (content[0] && ((content[0].html || '').replace(/<[^>]*>/g,'').trim().split('\
')[0] || content[0].type)) || ('Proyecto ' + new Date().toISOString());
      try{
        const docRef = await addDoc(collection(db, 'projects'), { uid: currentUser.uid, title, content, published: false, createdAt: serverTimestamp(), updatedAt: serverTimestamp() });
        localStorage.setItem('last_project_id', docRef.id);
        alert('‚úì Guardado en la nube (ID: ' + docRef.id + ')');
      } catch(err){ console.error('Save error', err); alert('Error guardando en la nube'); }
    }

    async function publishRemote(){
      if(!currentUser){ if(confirm('Necesitas iniciar sesi√≥n para publicar. Ir a iniciar sesi√≥n ahora?')) window.location.href = '/auth.html'; return; }
      const nodes = Array.from(document.querySelectorAll('#canvas .block'));
      const content = nodes.map(b=>({type:b.dataset.type || 'block', html: getBlockInnerHtml(b), props: b.dataset.props ? JSON.parse(b.dataset.props) : {}}));
      const html = nodes.map(b=>{
        const props = JSON.parse(b.dataset.props||'{}');
        const inner = getBlockInnerHtml(b);
        return `<section style="padding:${props.padding||40}px;background:${props.bg||'#fff'};color:${props.color||'#0f172a'};border-radius:${props.radius||8}px">${inner}</section>`;
      }).join('');
      const projectId = localStorage.getItem('last_project_id');
      try{
        let ref;
        if(projectId){ ref = doc(db, 'projects', projectId); await setDoc(ref, { content, html, published: true, updatedAt: serverTimestamp(), uid: currentUser.uid }, { merge: true }); }
        else { ref = await addDoc(collection(db, 'projects'), { uid: currentUser.uid, title: (content[0] ? (content[0].html || '').replace(/<[^>]*>/g,'').trim().split('\
')[0] : 'Published'), content, html, published: true, createdAt: serverTimestamp(), updatedAt: serverTimestamp() }); }
        localStorage.setItem('last_project_id', ref.id || projectId);
        const id = ref.id || projectId;
        alert('‚úì Publicado. Vista p√∫blica: /preview.html?id=' + id);
        window.open('/preview.html?id=' + id, '_blank');
      } catch(err){ console.error('Publish error', err); alert('Error publicando en la nube'); }
    }

    // Attachments
    document.getElementById('saveBtn').addEventListener('click', ()=>{ const content = Array.from(document.querySelectorAll('#canvas .block')).map(b=>({type:b.dataset.type||'block', html: getBlockInnerHtml(b), props: b.dataset.props ? JSON.parse(b.dataset.props) : {}})); localStorage.setItem('editor_draft', JSON.stringify(content)); saveRemote(); });
    document.getElementById('previewBtn').addEventListener('click', ()=>{ const content = Array.from(document.querySelectorAll('#canvas .block')).map(b=>{ const props = JSON.parse(b.dataset.props||'{}'); return `<section style="padding:${props.padding||40}px;border-bottom:1px solid #eee">${getBlockInnerHtml(b)}</section>`; }).join(''); const preview = window.open('about:blank','preview'); preview.document.write(`<!doctype html><html><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Preview</title><style>body{font-family:Inter,system-ui,Arial;padding:20px}</style></head><body>${content}</body></html>`); preview.document.close(); });
    document.getElementById('publishBtn').addEventListener('click', ()=>{ if(!confirm('¬øPublicar Landing Page ahora?')) return; publishRemote(); });

    // Load draft
    (function(){
      const draft = localStorage.getItem('editor_draft');
      if(draft){
        const arr = JSON.parse(draft);
        canvas.innerHTML = '';
        arr.forEach(item=>{
          const el = createBlockElement(item.type || 'block', item.label || item.type);
          if(item.props) el.dataset.props = JSON.stringify(item.props);
          if(item.html){ el.dataset.html = item.html; setBlockContent(el, item.html); }
          renderBlock(el);
          canvas.appendChild(el);
        });
      }
    })();

    // Expose some helpers
    window.saveRemote = saveRemote; window.publishRemote = publishRemote; window.renderBlock = renderBlock; window.createBlockElement = createBlockElement;

  </script>
</body>
</html>


























